<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hygiene Inspection | SG Hawker Centre</title>

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Shared navbar styles (if your group uses it) -->
  <link rel="stylesheet" href="assets/style.css">

  <!-- Hygiene theme CSS (your orange aesthetic) -->
  <link rel="stylesheet" href="./hygiene.css">
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold" href="../index.html">üçú SG Hawker Centre</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <li class="nav-item"><a class="nav-link nav-pill" href="../index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="../yifei hawker proj/index.html">Stall</a></li>
          <li class="nav-item"><a class="nav-link" href="../orders.html">Orders</a></li>
          <li class="nav-item"><a class="nav-link" href="../sg-hawker-project-leslie/feedback.html">Feedback</a></li>

          <li class="nav-item">
            <a class="nav-link nav-pill active" href="hygiene-inspection.html">Hygiene info</a>
          </li>

          <li class="nav-item"><a class="nav-link" href="../sg-hawker-project-leslie/analytics.html">Analytics</a></li>

          <li class="nav-item ms-lg-2">
            <a class="nav-link icon-btn" href="#"><i class="fa-regular fa-user"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="card">
      <h2>Hygiene Inspection</h2>
      <div class="small">Select a stall to view the latest hygiene grade and navigate to forms/history.</div>

      <div class="hr"></div>

      <div class="gradeGrid">
        <div>
          <label for="stallSelect">Choose a Stall</label>
          <select id="stallSelect"></select>

          <div class="hr"></div>

          <button class="btn primary" id="goFeedback">Hygiene Form</button>
        </div>

        <div class="gradePanel">
          <div class="small">Current Hygiene Grade</div>
          <div class="badge" id="gradeBadge">-</div>
          <div class="gradeMeaning" id="gradeMeaning">-</div>
          <div class="gradeDate">Last inspected - <span id="lastInspected">-</span></div>
        </div>
      </div>

      <div class="hr"></div>

      <button class="btn" id="goHistory">Inspection History</button>

      <div class="legend">
        <div class="item"><div class="mini">A</div><div class="small">90‚Äì100: Excellence</div></div>
        <div class="item"><div class="mini">B</div><div class="small">80‚Äì89: Good</div></div>
        <div class="item"><div class="mini">C</div><div class="small">70‚Äì79: Fair</div></div>
        <div class="item"><div class="mini">D</div><div class="small">Below 70: Poor</div></div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- IMPORTANT: load your storage + AppData functions -->
  <script src="./hygiene.js"></script>

  <!-- Page logic (NO module imports) -->
  <script>
    function prettyDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
    }

    function gradeMeaning(grade) {
      const g = String(grade || "").toUpperCase();
      if (g === "A") return "90‚Äì100: Excellence";
      if (g === "B") return "80‚Äì89: Good";
      if (g === "C") return "70‚Äì79: Fair";
      if (g === "D") return "Below 70: Poor";
      return "-";
    }

    function rememberStall(stallId) {
      try { localStorage.setItem("hygiene_selected_stall", stallId || ""); } catch (e) {}
    }

    function getRememberedStall() {
      try { return localStorage.getItem("hygiene_selected_stall") || ""; } catch (e) { return ""; }
    }

    function fillStallSelect(selectEl, opts) {
      const useRemembered = opts && opts.useRemembered;

      const stalls = (window.AppData && AppData.getStalls) ? AppData.getStalls() : [];
      selectEl.innerHTML = "";

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "-- Select a stall --";
      selectEl.appendChild(placeholder);

      for (const s of stalls) {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        selectEl.appendChild(opt);
      }

      if (useRemembered) {
        const remembered = getRememberedStall();
        if (remembered) selectEl.value = remembered;
      }
    }

    function getLatestInspectionForStall(stallId) {
      if (!window.AppData || !AppData.getLatestInspectionForStall) return null;
      return AppData.getLatestInspectionForStall(stallId);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const stallSelect = document.getElementById("stallSelect");
      const gradeBadge = document.getElementById("gradeBadge");
      const gradeMeaningEl = document.getElementById("gradeMeaning");
      const lastInspectedEl = document.getElementById("lastInspected");

      const params = new URLSearchParams(location.search);
      const qsStall = params.get("stall");

      fillStallSelect(stallSelect, { useRemembered: true });

      if (qsStall) stallSelect.value = qsStall;

      function render() {
        const stallId = stallSelect.value;
        rememberStall(stallId);

        if (!stallId) {
          gradeBadge.textContent = "-";
          gradeMeaningEl.textContent = "-";
          lastInspectedEl.textContent = "-";
          return;
        }

        const latest = getLatestInspectionForStall(stallId);

        if (!latest) {
          gradeBadge.textContent = "-";
          gradeMeaningEl.textContent = "No inspection record yet";
          lastInspectedEl.textContent = "-";
          return;
        }

        gradeBadge.textContent = latest.grade;
        gradeMeaningEl.textContent = gradeMeaning(latest.grade);
        lastInspectedEl.textContent = prettyDate(latest.date);
      }

      render();
      stallSelect.addEventListener("change", render);

      document.getElementById("goFeedback").addEventListener("click", () => {
        const id = stallSelect.value || "";
        if (!id) return;

        const loggedIn = sessionStorage.getItem("hygiene_logged_in") === "true";
        if (!loggedIn) {
          location.href = "hygiene-login.html?redirect=hygiene-feedback.html&stall=" + encodeURIComponent(id);
          return;
        }

        location.href = "hygiene-feedback.html?stall=" + encodeURIComponent(id);
      });

      document.getElementById("goHistory").addEventListener("click", () => {
        const id = stallSelect.value || "";
        if (!id) return;
        location.href = "hygiene-history.html?stall=" + encodeURIComponent(id);
      });
    });
  </script>
</body>
</html>
